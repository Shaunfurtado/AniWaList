<div x-data="libraryApp()" x-init="fetchLibrary()" x-cloak>
    
    <!-- Hero Header -->
    <div class="relative rounded-3xl bg-gradient-to-r from-gray-800 to-gray-900 border border-white/10 p-8 mb-10 overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
        
        <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Global Library</h1>
                <p class="text-gray-400 max-w-md">Your offline reference database. Scan your local JSON files to populate this list and quick-add to your watchlist.</p>
            </div>
            <div class="flex gap-3">
                <button @click="scanLibrary()" :disabled="scanning" 
                        class="px-5 py-3 bg-surface border border-white/10 hover:border-primary/50 text-white rounded-xl font-medium transition flex items-center gap-2 shadow-lg">
                    <i data-lucide="database" class="w-4 h-4" :class="{'animate-bounce': scanning}"></i>
                    <span x-text="scanning ? 'Scanning...' : 'Sync Database'"></span>
                </button>
                <a href="/api/library/export-csv" class="px-5 py-3 bg-primary hover:bg-indigo-500 text-white rounded-xl font-medium transition flex items-center gap-2 shadow-lg shadow-primary/20">
                    <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                </a>
            </div>
        </div>
    </div>

    <!-- Data Grid -->
    <div class="bg-[#13151b] rounded-2xl border border-white/5 overflow-hidden shadow-2xl">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="border-b border-white/5 bg-white/[0.02]">
                        <th class="px-8 py-5 text-xs font-bold text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-8 py-5 text-xs font-bold text-gray-500 uppercase tracking-wider">Anime Title</th>
                        <th class="px-8 py-5 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    <template x-for="item in items" :key="item.id">
                        <tr class="hover:bg-white/[0.02] transition group">
                            <td class="px-8 py-4 text-gray-500 font-mono text-xs" x-text="'#' + item.id"></td>
                            <td class="px-8 py-4 text-gray-200 font-medium text-sm" x-text="item.title"></td>
                            <td class="px-8 py-4 text-right">
                                <button @click="addToWatchlist(item.title)" 
                                        class="inline-flex items-center gap-2 px-4 py-1.5 bg-white/5 hover:bg-primary text-gray-300 hover:text-white rounded-lg text-xs font-bold transition border border-white/5 group-hover:border-primary/50">
                                    <i data-lucide="plus" class="w-3 h-3"></i> Add
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination (Kept simple for Library) -->
    <div class="flex justify-center items-center gap-4 mt-8 pb-10" x-show="totalPages > 1">
        <button @click="page--; fetchLibrary()" :disabled="page === 1" class="p-3 bg-surface border border-white/10 rounded-xl hover:bg-white/5 disabled:opacity-30 disabled:cursor-not-allowed transition">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>
        <span class="text-sm font-mono text-gray-500">Page <span x-text="page" class="text-white"></span> / <span x-text="totalPages"></span></span>
        <button @click="page++; fetchLibrary()" :disabled="page === totalPages" class="p-3 bg-surface border border-white/10 rounded-xl hover:bg-white/5 disabled:opacity-30 disabled:cursor-not-allowed transition">
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
    </div>
</div>

<script>
    function libraryApp() {
        return {
            items: [],
            page: 1,
            totalPages: 1,
            scanning: false,

            async fetchLibrary() {
                const res = await fetch(`/api/library?page=${this.page}`);
                const data = await res.json();
                this.items = data.library;
                this.totalPages = data.totalPages;
                this.page = data.currentPage;
                this.$nextTick(() => window.refreshIcons());
            },

            async scanLibrary() {
                this.scanning = true;
                try {
                    const res = await fetch('/api/scan-library', { method: 'POST' });
                    const data = await res.json();
                    this.fetchLibrary();
                } catch(e) { console.error(e); } 
                finally { this.scanning = false; }
            },

            async addToWatchlist(title) {
                const res = await fetch('/api/anime', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ titles: title, status: 'yet to watch' })
                });
                if(res.ok) alert('Added to Watchlist');
            }
        }
    }
</script>